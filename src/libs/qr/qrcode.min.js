var QRCode;
!function(){
    // === Core classes ===
    function QR8BitByte(data){
        this.mode = 4; // MODE_8BIT_BYTE
        this.data = data;
        this.parsedData = [];
        for (var b=[], d=0, e=this.data.length; d<e; d++){
            var f = this.data.charCodeAt(d);
            if(f>65536){
                b[0]=240|(1835008&f)>>>18;
                b[1]=128|(258048&f)>>>12;
                b[2]=128|(4032&f)>>>6;
                b[3]=128|63&f;
            } else if(f>2048){
                b[0]=224|(61440&f)>>>12;
                b[1]=128|(4032&f)>>>6;
                b[2]=128|63&f;
            } else if(f>128){
                b[0]=192|(1984&f)>>>6;
                b[1]=128|63&f;
            } else {
                b[0]=f;
            }
            this.parsedData = this.parsedData.concat(b);
        }
        if(this.parsedData.length != this.data.length){
            this.parsedData.unshift(191, 187, 239); // BOM
        }
    }
    QR8BitByte.prototype = {
        getLength: function(){ return this.parsedData.length; },
        write: function(buffer){
            for(var i=0; i<this.parsedData.length; i++){
                buffer.put(this.parsedData[i], 8);
            }
        }
    };

    // === Bit buffer ===
    function QRBitBuffer(){
        this.buffer = [];
        this.length = 0;
    }
    QRBitBuffer.prototype = {
        get: function(index){
            var bufIndex = Math.floor(index/8);
            return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) == 1;
        },
        put: function(num, length){
            for(var i=0; i<length; i++){
                this.putBit(((num >>> (length-i-1)) & 1) == 1);
            }
        },
        getLengthInBits: function(){ return this.length; },
        putBit: function(bit){
            var bufIndex = Math.floor(this.length/8);
            if(this.buffer.length <= bufIndex) this.buffer.push(0);
            if(bit) this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
            this.length++;
        }
    };

    // === Main QR code class ===
    var QRCodeModel = function(typeNumber, errorCorrectLevel){
        this.typeNumber = typeNumber;
        this.errorCorrectLevel = errorCorrectLevel;
        this.modules = null;
        this.moduleCount = 0;
        this.dataCache = null;
        this.dataList = [];
    };
    QRCodeModel.prototype = {
        addData: function(data){
            var newData = new QR8BitByte(data);
            this.dataList.push(newData);
            this.dataCache = null;
        },
        isDark: function(row, col){
            if(row<0 || row>=this.moduleCount || col<0 || col>=this.moduleCount){
                throw new Error(row+","+col);
            }
            return this.modules[row][col];
        },
        getModuleCount: function(){ return this.moduleCount; },
        make: function(){
            this.makeImpl(false, this.getBestMaskPattern());
        },
        makeImpl: function(test, maskPattern){
            this.moduleCount = 4 * this.typeNumber + 17;
            this.modules = new Array(this.moduleCount);
            for(var row=0; row<this.moduleCount; row++){
                this.modules[row] = new Array(this.moduleCount);
                for(var col=0; col<this.moduleCount; col++) this.modules[row][col] = null;
            }
            this.setupPositionProbePattern(0,0);
            this.setupPositionProbePattern(this.moduleCount-7,0);
            this.setupPositionProbePattern(0,this.moduleCount-7);
            this.setupTimingPattern();
            // Generate data
            if(this.dataCache == null) this.dataCache = QRCodeModel.createData(this.typeNumber, this.errorCorrectLevel, this.dataList);
            this.mapData(this.dataCache, maskPattern);
        },
        setupPositionProbePattern: function(row, col){
            for(var r=-1; r<=7; r++){
                if(row+r<0 || row+r>=this.moduleCount) continue;
                for(var c=-1; c<=7; c++){
                    if(col+c<0 || col+c>=this.moduleCount) continue;
                    this.modules[row+r][col+c] = (0<=r&&r<=6&&(c==0||c==6) || 0<=c&&c<=6&&(r==0||r==6) || 2<=r&&r<=4&&2<=c&&c<=4);
                }
            }
        },
        setupTimingPattern: function(){
            for(var i=8; i<this.moduleCount-8; i++){
                if(this.modules[i][6]==null) this.modules[i][6] = i%2==0;
                if(this.modules[6][i]==null) this.modules[6][i] = i%2==0;
            }
        },
        mapData: function(data, maskPattern){
            var inc = -1;
            var row = this.moduleCount - 1;
            var bitIndex = 7;
            var byteIndex = 0;
            for(var col=this.moduleCount-1; col>0; col-=2){
                if(col==6) col--;
                while(true){
                    for(var c=0; c<2; c++){
                        if(this.modules[row][col-c]==null){
                            var dark = false;
                            if(byteIndex<data.length){
                                dark = ((data[byteIndex]>>>bitIndex)&1)==1;
                            }
                            this.modules[row][col-c] = dark;
                            bitIndex--;
                            if(bitIndex==-1){
                                byteIndex++;
                                bitIndex=7;
                            }
                        }
                    }
                    row += inc;
                    if(row<0 || row>=this.moduleCount){
                        row -= inc;
                        inc = -inc;
                        break;
                    }
                }
            }
        },
        getBestMaskPattern: function(){ return 0; }
    };
    QRCodeModel.PAD0 = 236;
    QRCodeModel.PAD1 = 17;
    QRCodeModel.createData = function(typeNumber, errorCorrectLevel, dataList){
        var buffer = new QRBitBuffer();
        for(var i=0; i<dataList.length; i++){
            var data = dataList[i];
            buffer.put(data.mode, 4);
            buffer.put(data.getLength(), 8);
            data.write(buffer);
        }
        var totalDataCount = 100; // simplified fixed
        while(buffer.getLengthInBits() % 8 !=0) buffer.putBit(false);
        while(buffer.getLengthInBits() < totalDataCount*8){
            buffer.put(QRCodeModel.PAD0,8);
            if(buffer.getLengthInBits() >= totalDataCount*8) break;
            buffer.put(QRCodeModel.PAD1,8);
        }
        var data = [];
        for(var i=0; i<buffer.buffer.length; i++) data.push(buffer.buffer[i]);
        return data;
    };

    // === Drawing on Canvas ===
    var CanvasDrawing = function(el, options){
        this._el = el;
        this._elCanvas = document.createElement("canvas");
        this._el.appendChild(this._elCanvas);
        this._oContext = this._elCanvas.getContext("2d");
        this._options = options;
        this._elCanvas.width = options.width;
        this._elCanvas.height = options.height;
    };
    CanvasDrawing.prototype = {
        draw: function(qr){
            var ctx = this._oContext;
            var count = qr.getModuleCount();
            var w = this._options.width / count;
            var h = this._options.height / count;
            ctx.fillStyle = this._options.colorLight;
            ctx.fillRect(0,0,this._options.width,this._options.height);
            for(var r=0; r<count; r++){
                for(var c=0; c<count; c++){
                    ctx.fillStyle = qr.isDark(r,c)?this._options.colorDark:this._options.colorLight;
                    ctx.fillRect(c*w, r*h, w, h);
                }
            }
        },
        clear: function(){
            this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height);
        }
    };

    // === Public QRCode ===
    QRCode = function(el, options){
        this._el = typeof el === "string"?document.getElementById(el):el;
        this._options = Object.assign({
            width:300,
            height:300,
            colorDark:"#000000",
            colorLight:"#ffffff",
            correctLevel: 2, // High
            text:""
        }, options);
        this._drawing = new CanvasDrawing(this._el, this._options);
        if(this._options.text) this.makeCode(this._options.text);
    };
    QRCode.prototype.makeCode = function(text){
        this._qr = new QRCodeModel(4, this._options.correctLevel);
        this._qr.addData(text);
        this._qr.make();
        this._drawing.draw(this._qr);
    };
    QRCode.prototype.clear = function(){
        this._drawing.clear();
    };
}();
